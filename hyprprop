#!/usr/bin/env sh

socat -u UNIX-CONNECT:/tmp/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock \
         EXEC:"hyprevents /usr/share/hyprprop/events_handler",nofork 2>/dev/null &

prop() {
    HYPR_TREE=$(hyprctl clients -j)

    echo $HYPR_TREE | jq -r ".[] | select(.workspace.id == "$(hyprctl activewindow -j | jq -r '.workspace.id')\)""| jq -r ".at,.size" | jq -s "add" | jq '_nwise(4)' | jq -r '"\(.[0]),\(.[1]) \(.[2])x\(.[3])"'| slurp > .slurp_out 2> .slurp_error &
    PID=$!
    wait $PID

    ERROR=$(cat .slurp_error) # invalid box format: null,null nullxnull
    rm .slurp_error
    [ -n "$ERROR" ] && prop

    SELECTION=$(cat .slurp_out)
    rm .slurp_out
    [ -z "$SELECTION" ] && killall hyprevents && exit

    # Extract the X, Y, Width, and Height from the selection
    X=$(echo $SELECTION | awk -F'[, x]' '{print $1}')
    Y=$(echo $SELECTION | awk -F'[, x]' '{print $2}')
    W=$(echo $SELECTION | awk -F'[, x]' '{print $3}')
    H=$(echo $SELECTION | awk -F'[, x]' '{print $4}')

    WORKSPACE=$(hyprctl activewindow -j | jq -r '.workspace.id')

    # Find the window matching the selection
    echo $HYPR_TREE | jq -r --argjson x $X --argjson y $Y --argjson w $W --argjson h $H --argjson i $WORKSPACE \
            '.[] | select(.workspace.id == $i and .at[0] == $x and .at[1] == $y and .size[0] == $w and .size[1] == $h)'

    killall hyprevents
    exit
}

handler() {
    pkill slurp
    wait $PID 2>/dev/null
    prop
}

trap handler USR1
prop
